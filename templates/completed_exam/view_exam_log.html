{% extends "layout.html" %}
{% load static %}

{% block stylesheet %}<link rel="stylesheet" href="{% static 'css/completed_exam.css'%}">{% endblock stylesheet %}

{% block content %} 
<div class="row m-3">
    <div class="col-9">
        <div class="card mx-auto shadow">
            <div class="card-body p-3">
                <!--Activity Log div-->
                <div id="log_div" {% if curr_view == 'sc' %}style="display:none;"{% else %}style="display:block;"{% endif %}>
                    <div class="d-flex justify-content-between">
                        <h3>Browser Activity Log</h3>
                        <div class="btn-group me-4">
                            <a href="?view=log&log-page={{ log_page_number }}&screen-page={{ screen_page_number }}" class="btn btn-primary border" onclick="showLog();"><i class="bi bi-list-columns-reverse"></i></a>
                            <a href="?view=sc&log-page={{ log_page_number }}&screen-page={{ screen_page_number }}" class="btn btn-light border" onclick="showScreenCapture();"><i class="bi bi-camera-video"></i></a>
                        </div>
                    </div>
                    
                    <hr class="my-2">

                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 2.5%;">#</th>
                                <th scope="col" style="width: 2.5%;"></th>
                                <th scope="col" style="width: 75%;">Activity</th>
                                <th scope="col" style="width: 20%;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for log in browser_activity.activity_log %}
                            <tr class>
                                <td>{{forloop.counter}}</td>
                                <td>
                                    {% if log.status == 2 %}
                                        <i class="bi bi-exclamation-diamond-fill text-danger"></i>
                                    {% elif log.status == 1 %}
                                        <i class="bi bi-exclamation-diamond-fill text-warning"></i>
                                    {% endif %}    
                                </td>
                                <td>{{log.activity}}</td>
                                <td>{{log.timestamp}}</td>   
                            </tr>                    
                        {% endfor %}
                        </tbody>
                    </table>

                    <!--Pagination-->
                    <nav class="mb-1">
                        <ul class="pagination justify-content-center pagination-clean my-0">
                            {% if browser_activity.activity_log.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?view=log&log-page={{ browser_activity.activity_log.previous_page_number }}&screen-page={{ screen_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}

                            {% with browser_activity.activity_log.number|add:"-4" as start_page %}
                            {% with browser_activity.activity_log.number|add:"4" as end_page %}
                            {% for num in browser_activity.activity_log.paginator.page_range %}
                            {% if num >= start_page and num <= end_page %}
                            <li class="page-item {% if browser_activity.activity_log.number == num %}active{% endif %}">
                                <a class="page-link" href="?view=log&log-page={{ num }}&screen-page={{ screen_page_number }}">{{ num }}</a>
                            </li>
                            {% endif %}
                            {% endfor %}
                            {% endwith %}
                            {% endwith %}

                            {% if browser_activity.activity_log.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?view=log&log-page={{ browser_activity.activity_log.next_page_number }}&screen-page={{ screen_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>

                <!--Screen Capture div-->
                <div id="screen_capture_div" {% if curr_view == 'sc' %}style="display:block;"{% else %}style="display:none;"{% endif %}>
                    <div class="d-flex justify-content-between">
                        <h3>Screen Capture</h3>
                        <div class="btn-group me-4">
                            <a href="?view=log&log-page={{ log_page_number }}&screen-page={{ screen_page_number }}" class="btn btn-light border" onclick="showLog();"><i class="bi bi-list-columns-reverse"></i></a>
                            <a href="?view=sc&log-page={{ log_page_number }}&screen-page={{ screen_page_number }}" class="btn btn-primary border" onclick="showScreenCapture();"><i class="bi bi-camera-video"></i></a>
                        </div>
                    </div>
                    <hr class="my-2">
                    <!--Video-->
                    {% if curr_video_url %}
                        <div class="d-flex justify-content-center w-100 p-2">
                            <video class="w-75" controls>       
                                <source src="{{curr_video_url}}" type="video/webm">
                                Your browser does not support the video tag.
                            </video>
                        </div>
                    {% else %}
                    <div class="d-flex justify-content-center w-100 p-2">
                        <h2>No Screen Recorded</h2>
                    </div>
                    {% endif %}

                    <!--Pagination-->
                    <nav class="mb-1">
                        <ul class="pagination justify-content-center pagination-clean my-0">
                            {% if video_urls.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?view=sc&screen-page={{ video_urls.previous_page_number }}&log-page={{ log_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in video_urls.paginator.page_range %}
                            <li class="page-item {% if video_urls.number == num %}active{% endif %}">
                                <a class="page-link" href="?view=sc&screen-page={{ num }}&log-page={{ log_page_number }}">{{ num }}</a>
                            </li>
                            {% endfor %}

                            {% if video_urls.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?view=sc&screen-page={{ video_urls.next_page_number }}&log-page={{ log_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <a class="page-link" href="#" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>


                </div>
            </div>
        </div>

    </div>

    <div class="col-3">
        <div class="card mx-auto shadow">
            <div class="card-body p-3">
                <h3>Student Detail</h3>
                <hr class="my-2">
                <table class="table table-borderless m-0">
                    <tbody>
                        <tr>
                            <th style="width:45%">Name</th>
                            <td style="width:1%">:</td>
                            <td style="width:54%">
                                <a href="" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#student_profile_modal">{{ completed_exam.student.user.first_name }} {{ completed_exam.student.user.last_name }}</a>
                            </td>
                        </tr>
                        <tr>
                            <th>Course</th>
                            <td>:</td>
                            <td>{{ completed_exam.exam.question_bank.course.name }}</td>
                        </tr>
                        <tr>
                            <th>Time Taken</th>
                            <td>:</td>
                            <td>
                                {{ completed_exam.time_taken }} seconds
                            </td>
                        </tr>
                        <tr>
                            <th>Current Marks</th>
                            <td>:</td>
                            {% if  not completed_exam.exam_passed %}
                                <td class="bg-danger text-light"><strong>Fail</strong></td>   
                            {% else %}
                            <td>
                                <span class="text-decoration-underline">{{ completed_exam.total_mark }}</span> / {{ completed_exam.full_mark }}
                            </td>
                            {% endif %}
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="student_profile_modal" tabindex="-1" aria-labelledby="student_profile_modal_label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="student_profile_modal_label">Student Profile</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="row g-4">
                <!-- Profile Picture Section -->
                <div class="col-12 col-4 text-center">
                    <div class="container">
                        <div class="d-flex justify-content-center mb-3">
                            {% if user_profile.profile_picture %}
                                <img src="{{ completed_exam.student.user.student.profile_picture.url }}" alt="Profile Picture" class="img-fluid rounded-circle" style="width: 100%; max-width: 125px; height: auto; height: 125px;">
                            {% else %}
                                <img src="/media/profile_pictures/default.jpg" alt="Default Profile Picture" class="img-fluid rounded-circle" style="width: 100%; max-width: 125px; height: auto; height: 125px;">
                            {% endif %}
                        </div>
                    </div>
                </div>


                <div>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6">
                            <strong class="fs-4">Name:</strong>
                            <p class="fs-5 text-center text-md-start">{{ completed_exam.student.user.first_name | capfirst }} {{ completed_exam.student.user.last_name | capfirst }}</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6">
                            <strong class="fs-4">Programme:</strong>
                            <p class="fs-5">{{ completed_exam.student.user.student.programme }}</p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 col-md-6">
                            <strong class="fs-4">Email:</strong>
                            <p class="fs-5">{{ completed_exam.student.user.email }}</p>
                        </div>
                        <div class="col-12 col-md-6">
                            <strong class="fs-4">Phone Number:</strong>
                            <p class="fs-5">{{ completed_exam.student.user.student.phone_num }}</p>
                        </div>
                    </div>
                </div>
        </div>
      </div>
    </div>
</div>

{% endblock content %}

{% block script %}
    <script src="{% static 'js/completed_exam.js' %}"></script>

    <script>
        window.onload = function() {
            var videoElement = document.getElementById('video');
            var videoSource = document.getElementById('video-source');
            var thumbnailElement = document.getElementById('video-thumbnail');
            
            // Wait for the video metadata to be loaded
            videoElement.onloadedmetadata = function() {
                // Seek to a specific time to capture the thumbnail (e.g., 1 second into the video)
                videoElement.currentTime = 1;
    
                // Capture the frame when the video is ready
                videoElement.onseeked = function() {
                    var canvas = document.createElement('canvas');
                    var context = canvas.getContext('2d');
                    
                    // Set the canvas size to the video's dimensions
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
    
                    // Draw the current video frame on the canvas
                    context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
    
                    // Convert the canvas to a data URL and set it as the image source
                    var thumbnailDataUrl = canvas.toDataURL('image/png');
                    thumbnailElement.src = thumbnailDataUrl;
                };
            };
        };
    </script>
{% endblock script %}